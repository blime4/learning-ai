<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>llama.cpp å­¦ä¹ è·¯çº¿å›¾</title>
<style>
  :root {
    --bg: #0d1117; --card: #161b22; --border: #30363d;
    --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff;
    --green: #3fb950; --yellow: #d29922; --purple: #bc8cff;
    --red: #f85149; --orange: #f0883e;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }

  .container { max-width: 960px; margin: 0 auto; padding: 24px 16px; }

  header { text-align: center; padding: 40px 0 32px; }
  header h1 { font-size: 2em; margin-bottom: 8px; }
  header h1 span { color: var(--accent); }
  header p { color: var(--muted); font-size: 0.95em; }

  /* Overall progress */
  .overall { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px 24px; margin-bottom: 32px; }
  .overall h2 { font-size: 1.1em; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .overall h2 .emoji { font-size: 1.3em; }
  .progress-bar { background: var(--border); border-radius: 8px; height: 20px; overflow: hidden; position: relative; }
  .progress-fill { height: 100%; border-radius: 8px; background: linear-gradient(90deg, var(--green), var(--accent)); transition: width 0.5s ease; }
  .progress-text { text-align: center; margin-top: 8px; color: var(--muted); font-size: 0.9em; }
  .stats { display: flex; gap: 24px; margin-top: 16px; flex-wrap: wrap; }
  .stat { display: flex; align-items: center; gap: 6px; font-size: 0.85em; color: var(--muted); }
  .stat .dot { width: 10px; height: 10px; border-radius: 50%; }

  /* Streak */
  .streak-bar { display: flex; align-items: center; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .streak-bar .fire { font-size: 1.4em; }
  .streak-info { font-size: 0.85em; color: var(--muted); }
  .streak-info strong { color: var(--orange); font-size: 1.1em; }
  .streak-cal { display: flex; gap: 3px; margin-left: auto; }
  .streak-day { width: 14px; height: 14px; border-radius: 3px; background: var(--border); }
  .streak-day.active { background: var(--green); }
  .streak-day.today { outline: 2px solid var(--accent); }

  /* Phase */
  .phase { background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
  .phase-header { padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; user-select: none; }
  .phase-header:hover { background: rgba(88,166,255,0.05); }
  .phase-icon { font-size: 1.3em; }
  .phase-title { flex: 1; font-size: 1em; font-weight: 600; }
  .phase-badge { font-size: 0.75em; padding: 2px 10px; border-radius: 12px; background: var(--border); color: var(--muted); }
  .phase-badge.done { background: rgba(63,185,80,0.15); color: var(--green); }
  .phase-arrow { color: var(--muted); transition: transform 0.3s; font-size: 0.8em; }
  .phase.open .phase-arrow { transform: rotate(90deg); }
  .phase-progress { height: 3px; background: var(--border); }
  .phase-progress-fill { height: 100%; background: var(--green); transition: width 0.4s; }
  .phase-body { display: none; padding: 0 20px 16px; }
  .phase.open .phase-body { display: block; }

  /* Item */
  .item { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .item:last-child { border-bottom: none; }
  .item input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; margin-top: 2px; position: relative; transition: all 0.2s; }
  .item input[type="checkbox"]:checked { background: var(--green); border-color: var(--green); }
  .item input[type="checkbox"]:checked::after { content: 'âœ“'; position: absolute; top: -1px; left: 3px; color: #fff; font-size: 14px; font-weight: bold; }
  .item-num { color: var(--accent); font-weight: 700; font-size: 0.85em; min-width: 28px; margin-top: 2px; }
  .item-content { flex: 1; }
  .item-file { font-size: 0.85em; color: var(--purple); word-break: break-all; }
  .item-file a { color: var(--purple); text-decoration: none; }
  .item-file a:hover { text-decoration: underline; }
  .item-desc { font-size: 0.85em; color: var(--muted); margin-top: 2px; }
  .item.checked .item-file a { color: var(--muted); text-decoration: line-through; }
  .item.checked .item-desc { text-decoration: line-through; opacity: 0.6; }
  .item-date { font-size: 0.7em; color: var(--muted); margin-top: 4px; }

  /* Buttons */
  .actions { text-align: center; margin: 24px 0; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
  .btn { padding: 8px 20px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.danger:hover { border-color: var(--red); color: var(--red); }

  footer { text-align: center; padding: 32px 0; color: var(--muted); font-size: 0.8em; }

  /* Animation button in items */
  .anim-btn { background: linear-gradient(135deg, var(--accent), var(--purple)); border: none; color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.75em; cursor: pointer; margin-left: 8px; transition: transform 0.2s, box-shadow 0.2s; }
  .anim-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88,166,255,0.3); }

  /* ========== ALGORITHM VISUALIZATION MODAL ========== */
  .viz-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
  .viz-modal.open { display: flex; flex-direction: column; }

  .viz-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #111; border-bottom: 1px solid #222; }
  .viz-title { font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 10px; }
  .viz-title .badge { font-size: 0.7em; padding: 2px 8px; background: var(--accent); color: #000; border-radius: 4px; }
  .viz-close { background: none; border: none; color: var(--muted); font-size: 1.8em; cursor: pointer; line-height: 1; padding: 0 4px; }
  .viz-close:hover { color: var(--text); }

  .viz-main { flex: 1; display: flex; overflow: hidden; }

  /* Canvas area */
  .viz-canvas { flex: 1; display: flex; flex-direction: column; background: linear-gradient(180deg, #0a0e14 0%, #0d1117 100%); position: relative; overflow: hidden; }
  .viz-canvas-inner { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; }

  /* Array visualization */
  .viz-array { display: flex; align-items: flex-start; gap: 0; position: relative; }
  .viz-cell { width: 64px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1f2a; border: 2px solid #2d3748; border-radius: 8px; position: relative; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
  .viz-cell.highlight { border-color: var(--accent); box-shadow: 0 0 20px rgba(88,166,255,0.4); z-index: 10; }
  .viz-cell.merged { border-color: var(--green); background: rgba(63,185,80,0.15); }
  .viz-cell.deleted { opacity: 0.2; transform: scale(0.8); }
  .viz-cell.proc { border-color: var(--orange); }

  .viz-char { font-size: 1.6em; font-weight: 700; color: #fff; }
  .viz-idx { font-size: 0.65em; color: var(--muted); position: absolute; top: 4px; left: 6px; }
  .viz-ptr { font-size: 0.6em; color: #666; margin-top: 4px; font-family: monospace; }

  /* Arrows between cells */
  .viz-arrow { width: 24px; display: flex; align-items: center; justify-content: center; color: #3d4a5c; font-size: 1.2em; transition: all 0.3s; }
  .viz-arrow.hidden { opacity: 0; }

  /* Queue visualization */
  .viz-queue { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(17,20,28,0.95); border: 1px solid #2d3748; border-radius: 12px; padding: 16px 20px; min-width: 300px; }
  .viz-queue-title { font-size: 0.7em; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .viz-queue-items { display: flex; gap: 8px; flex-wrap: wrap; }
  .viz-queue-item { padding: 4px 10px; background: #2d3748; border-radius: 4px; font-size: 0.75em; font-family: monospace; transition: all 0.3s; }
  .viz-queue-item.top { background: var(--accent); color: #000; font-weight: 600; }
  .viz-queue-item.done { opacity: 0.3; text-decoration: line-through; }

  /* Info panel */
  .viz-info { width: 360px; background: #111; border-left: 1px solid #222; display: flex; flex-direction: column; overflow: hidden; }
  .viz-info-header { padding: 16px 20px; border-bottom: 1px solid #222; }
  .viz-step-num { font-size: 0.75em; color: var(--accent); margin-bottom: 4px; }
  .viz-step-title { font-size: 1em; font-weight: 600; }

  .viz-info-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
  .viz-section { margin-bottom: 20px; }
  .viz-section-title { font-size: 0.7em; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
  .viz-desc { font-size: 0.9em; color: var(--text); line-height: 1.7; }
  .viz-desc code { background: #1a1f2a; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; color: var(--accent); }

  /* Code block */
  .viz-code { background: #0a0e14; border-radius: 8px; padding: 12px; overflow-x: auto; }
  .viz-code pre { margin: 0; font-size: 0.8em; line-height: 1.6; font-family: 'JetBrains Mono', 'Fira Code', monospace; }
  .viz-code .line { padding: 2px 8px; margin: 0 -8px; border-radius: 4px; color: #8b949e; }
  .viz-code .line.hl { background: rgba(88,166,255,0.12); color: #fff; }
  .viz-code .kw { color: var(--purple); }
  .viz-code .fn { color: var(--accent); }
  .viz-code .str { color: var(--green); }
  .viz-code .cmt { color: #555; font-style: italic; }

  /* Controls */
  .viz-controls { display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: #0a0e14; border-top: 1px solid #222; }
  .viz-ctrl-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #1a1f2a; border: 1px solid #2d3748; border-radius: 8px; color: var(--text); cursor: pointer; font-size: 1.1em; transition: all 0.2s; }
  .viz-ctrl-btn:hover:not(:disabled) { background: #2d3748; border-color: var(--accent); }
  .viz-ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .viz-ctrl-btn.primary { background: var(--accent); border-color: var(--accent); color: #000; }

  .viz-progress { flex: 1; height: 4px; background: #2d3748; border-radius: 2px; margin: 0 16px; cursor: pointer; position: relative; }
  .viz-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
  .viz-progress-text { font-size: 0.75em; color: var(--muted); min-width: 60px; text-align: right; }

  /* Output box */
  .viz-output { background: rgba(63,185,80,0.1); border: 1px solid rgba(63,185,80,0.3); border-radius: 8px; padding: 12px; margin-top: 12px; }
  .viz-output-label { font-size: 0.7em; color: var(--green); text-transform: uppercase; margin-bottom: 4px; }
  .viz-output-value { font-family: monospace; color: var(--green); font-size: 0.9em; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ğŸ¦™ <span>llama.cpp</span> å­¦ä¹ è·¯çº¿å›¾</h1>
    <p>46 ä¸ªçŸ¥è¯†ç‚¹ Â· 10 ä¸ªé˜¶æ®µ Â· ä»åŸºç¡€åˆ° Agent å…¨è¦†ç›–</p>
  </header>

  <div class="overall">
    <h2><span class="emoji">ğŸ“Š</span> æ€»ä½“è¿›åº¦</h2>
    <div class="progress-bar"><div class="progress-fill" id="overallFill" style="width:0%"></div></div>
    <div class="progress-text" id="overallText">0 / 48 å®Œæˆ (0%)</div>
    <div class="stats">
      <div class="stat"><span class="dot" style="background:var(--green)"></span> <span id="statDone">0</span> å·²å®Œæˆ</div>
      <div class="stat"><span class="dot" style="background:var(--border)"></span> <span id="statTodo">48</span> å¾…å­¦ä¹ </div>
      <div class="stat"><span class="dot" style="background:var(--accent)"></span> é¢„è®¡ <span id="statDays">48</span> å¤©</div>
    </div>
    <div class="streak-bar">
      <span class="fire">ğŸ”¥</span>
      <div class="streak-info">è¿ç»­å­¦ä¹  <strong id="streakCount">0</strong> å¤©</div>
      <div class="streak-cal" id="streakCal"></div>
    </div>
  </div>

  <div id="phases"></div>

  <div class="actions">
    <button class="btn" onclick="expandAll()">å±•å¼€å…¨éƒ¨</button>
    <button class="btn" onclick="collapseAll()">æŠ˜å å…¨éƒ¨</button>
    <button class="btn" onclick="exportProgress()">å¯¼å‡ºè¿›åº¦ JSON</button>
    <button class="btn" onclick="importProgress()">å¯¼å…¥è¿›åº¦</button>
    <button class="btn danger" onclick="resetAll()">é‡ç½®è¿›åº¦</button>
  </div>

  <footer>æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorage Â· åŸºäº <a href="https://github.com/blime4/learning-ai" style="color:var(--accent)">learning-ai</a> ä»“åº“</footer>
</div>

<!-- Visualization Modal -->
<div class="viz-modal" id="vizModal">
  <div class="viz-header">
    <div class="viz-title">
      BPE åˆ†è¯ç®—æ³•å¯è§†åŒ–
      <span class="badge">llama.cpp</span>
    </div>
    <button class="viz-close" onclick="closeViz()">&times;</button>
  </div>
  <div class="viz-main">
    <div class="viz-canvas">
      <div class="viz-canvas-inner">
        <div class="viz-array" id="vizArray"></div>
      </div>
      <div class="viz-queue" id="vizQueueBox" style="display:none;">
        <div class="viz-queue-title">ä¼˜å…ˆé˜Ÿåˆ— (æŒ‰ rank æ’åº)</div>
        <div class="viz-queue-items" id="vizQueue"></div>
      </div>
    </div>
    <div class="viz-info">
      <div class="viz-info-header">
        <div class="viz-step-num" id="vizStepNum">STEP 1/6</div>
        <div class="viz-step-title" id="vizStepTitle">åˆå§‹åŒ–</div>
      </div>
      <div class="viz-info-body">
        <div class="viz-section">
          <div class="viz-section-title">è¯´æ˜</div>
          <div class="viz-desc" id="vizDesc"></div>
        </div>
        <div class="viz-section">
          <div class="viz-section-title">ä»£ç </div>
          <div class="viz-code"><pre id="vizCode"></pre></div>
        </div>
        <div id="vizOutputBox" style="display:none;">
          <div class="viz-output">
            <div class="viz-output-label">è¾“å‡º</div>
            <div class="viz-output-value" id="vizOutput"></div>
          </div>
        </div>
      </div>
      <div class="viz-controls">
        <button class="viz-ctrl-btn" id="vizPrevBtn" onclick="vizPrev()">â—€</button>
        <button class="viz-ctrl-btn primary" id="vizPlayBtn" onclick="vizTogglePlay()">â–¶</button>
        <button class="viz-ctrl-btn" id="vizNextBtn" onclick="vizNext()">â–¶</button>
        <div class="viz-progress" onclick="vizSeek(event)">
          <div class="viz-progress-fill" id="vizProgressFill"></div>
        </div>
        <span class="viz-progress-text" id="vizProgressText">1 / 6</span>
      </div>
    </div>
  </div>
</div>

<script>
const REPO = 'https://github.com/blime4/learning-ai/blob/main/';
const PHASES = [
  {icon:'ğŸ—ï¸', title:'ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ä¸ç¯å¢ƒæ­å»º', items:[
    {n:'1', files:['fundamentals/ggml/README.md'], desc:'GGML åº•å±‚å¼ é‡åº“ â€” tensorã€backendã€è®¡ç®—å›¾'},
    {n:'2', files:['fundamentals/llama.cpp/README.md'], desc:'é¡¹ç›®å…¥å£ï¼šå­æ¨¡å—é…ç½®ã€ç¼–è¯‘ã€GDB è°ƒè¯•ã€CUDA æ„å»º'},
    {n:'3', files:['notes/llama.cpp/debugging.md'], desc:'è°ƒè¯•æŠ€å·§'},
  ]},
  {icon:'âš™ï¸', title:'ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¦‚å¿µï¼ˆæ¨ç†æµæ°´çº¿ï¼‰', items:[
    {n:'4', files:['fundamentals/llama.cpp/src/tokenize.cpp','notes/llama.cpp/llama-vocab-notes.md'], desc:'åˆ†è¯å™¨ â€” æ¨ç†çš„ç¬¬ä¸€æ­¥', anim:'bpe'},
    {n:'5', files:['fundamentals/llama.cpp/src/simple-prompt.cpp'], desc:'æœ€ç®€å•çš„æ¨ç†ç¤ºä¾‹'},
    {n:'6', files:['notes/llama.cpp/llama-batch.md'], desc:'llama_batch / llama_ubatch ç»“æ„'},
    {n:'7', files:['notes/llama.cpp/process_ubatch.md'], desc:'micro-batch å¤„ç†ç»†èŠ‚'},
    {n:'8', files:['notes/llama.cpp/kv-cache.md'], desc:'KV ç¼“å­˜æœºåˆ¶ â€” æ¨ç†åŠ é€Ÿæ ¸å¿ƒ'},
    {n:'9', files:['fundamentals/llama.cpp/src/kv-cache.cpp'], desc:'KV ç¼“å­˜ä»£ç å®è·µ'},
    {n:'10', files:['notes/llama.cpp/graph-inputs.md'], desc:'è®¡ç®—å›¾è¾“å…¥æ„å»º'},
    {n:'11', files:['notes/llama.cpp/gpu-sampling.md'], desc:'GPU é‡‡æ ·ï¼ˆtemperatureã€top-kã€top-pï¼‰'},
    {n:'12', files:['notes/llama.cpp/output_ids.md'], desc:'è¾“å‡º token ID å¤„ç†'},
    {n:'13', files:['fundamentals/llama.cpp/src/simple-prompt-multi.cpp'], desc:'å¤š prompt æ‰¹å¤„ç†'},
  ]},
  {icon:'ğŸš€', title:'ç¬¬ä¸‰é˜¶æ®µï¼šGPU åŠ é€Ÿä¸åç«¯', items:[
    {n:'14', files:['notes/llama.cpp/cuda.md'], desc:'CUDA åç«¯åŠ è½½æœºåˆ¶'},
    {n:'15', files:['notes/llama.cpp/cuda-mul-mat.md'], desc:'CUDA çŸ©é˜µä¹˜æ³•'},
    {n:'16', files:['notes/llama.cpp/cuda-fp16-release-build-issue.md'], desc:'FP16 æ„å»ºé—®é¢˜'},
    {n:'17', files:['fundamentals/ggml/src/llama-att-softmax.cpp'], desc:'attention softmax GGML å®ç°'},
    {n:'18', files:['notes/llama.cpp/flash-attn-misalignment-issue.md'], desc:'Flash Attention å¯¹é½é—®é¢˜'},
    {n:'19', files:['notes/llama.cpp/macosx.md'], desc:'macOS (Metal) å¹³å°'},
    {n:'20', files:['notes/llama.cpp/ggml-threadpool-macos-issue.md'], desc:'çº¿ç¨‹æ± é—®é¢˜'},
  ]},
  {icon:'ğŸ“¦', title:'ç¬¬å››é˜¶æ®µï¼šæ¨¡å‹è½¬æ¢ä¸é‡åŒ–', items:[
    {n:'21', files:['notes/llama.cpp/convert.md'], desc:'convert_hf_to_gguf.py æµç¨‹'},
    {n:'22', files:['notes/llama.cpp/quantization.md'], desc:'é‡åŒ–åŸç†ä¸ QAT'},
    {n:'23', files:['notes/llama.cpp/convert-dequantize.md'], desc:'åé‡åŒ–è¿‡ç¨‹'},
    {n:'24', files:['notes/llama.cpp/devstral2-conversion.md'], desc:'Devstral2 è½¬æ¢å®ä¾‹'},
    {n:'25', files:['notes/llama.cpp/convert-mamba-issue.md'], desc:'Mamba è½¬æ¢é—®é¢˜'},
    {n:'26', files:['notes/llama.cpp/gema-bos-issue.md'], desc:'Gemma BOS token é—®é¢˜'},
  ]},
  {icon:'ğŸ”¢', title:'ç¬¬äº”é˜¶æ®µï¼šEmbeddings', items:[
    {n:'27', files:['fundamentals/llama.cpp/src/embeddings.cpp'], desc:'embedding ç”Ÿæˆä»£ç '},
    {n:'28', files:['notes/llama.cpp/embeddings-presets.md'], desc:'embedding é¢„è®¾é…ç½®'},
  ]},
  {icon:'ğŸŒ', title:'ç¬¬å…­é˜¶æ®µï¼šServer ä¸éƒ¨ç½²', items:[
    {n:'29', files:['notes/llama.cpp/llama-server.md'], desc:'server å¯åŠ¨ä¸ API'},
    {n:'30', files:['notes/llama.cpp/server-checkpoints.md'], desc:'checkpoint ç®¡ç†'},
    {n:'31', files:['notes/llama.cpp/server-logprob-issue.md'], desc:'log probability é—®é¢˜'},
    {n:'32', files:['notes/llama.cpp/server-unit-tests.md'], desc:'server æµ‹è¯•'},
    {n:'33', files:['notes/llama.cpp/llama-perplexity.md'], desc:'å›°æƒ‘åº¦è®¡ç®—'},
    {n:'34', files:['notes/llama.cpp/tests.md'], desc:'æµ‹è¯•æ¡†æ¶'},
    {n:'35', files:['notes/llama.cpp/sbatch.md'], desc:'SLURM æ‰¹é‡æäº¤'},
  ]},
  {icon:'ğŸ¯', title:'ç¬¬ä¸ƒé˜¶æ®µï¼šFinetuning', items:[
    {n:'36', files:['fundamentals/llama.cpp/README.md'], desc:'LoRA å¾®è°ƒã€Shakespeareã€chat æ ¼å¼è®­ç»ƒ'},
  ]},
  {icon:'ğŸ‘ï¸', title:'ç¬¬å…«é˜¶æ®µï¼šå¤šæ¨¡æ€ä¸ç‰¹æ®Šæ¨¡å‹', items:[
    {n:'37', files:['notes/llama.cpp/llama-3-2-vision.md'], desc:'Llama 3.2 è§†è§‰æ¨¡å‹'},
    {n:'38', files:['notes/llama.cpp/qwen-2.5VL-3B-instruct.md'], desc:'Qwen è§†è§‰æ¨¡å‹'},
    {n:'39', files:['notes/llama.cpp/vision-model-issue.md'], desc:'è§†è§‰æ¨¡å‹é—®é¢˜'},
    {n:'40', files:['fundamentals/image-processing/src/mllama.cpp'], desc:'Llama è§†è§‰æ¨¡å‹å®ç°'},
    {n:'41', files:['notes/llama.cpp/tts.md'], desc:'TTS é›†æˆ'},
  ]},
  {icon:'ğŸ¤–', title:'ç¬¬ä¹é˜¶æ®µï¼šAgent ä¸ä¸Šå±‚åº”ç”¨', items:[
    {n:'42', files:['agents/llama-cpp-agent/README.md'], desc:'WASM agent æ¡†æ¶'},
    {n:'43', files:['agents/llama-cpp-agent/agent/src/main.rs','agents/llama-cpp-agent/agent/src/agent.rs','agents/llama-cpp-agent/agent/src/tool.rs'], desc:'Rust agent å®ç°'},
  ]},
  {icon:'ğŸ”—', title:'ç¬¬åé˜¶æ®µï¼šå…¶ä»–è¯­è¨€ç»‘å®šä¸é›†æˆ', items:[
    {n:'44', files:['fundamentals/python/src/llama-chat-format.py'], desc:'Python chat æ ¼å¼'},
    {n:'45', files:['fundamentals/rust/llm-chains-llama-example/README.md'], desc:'Rust LLM chains + Llama'},
    {n:'46', files:['fundamentals/rust/llm-chains-chat-demo/src/main-llama.rs'], desc:'Rust chat demo'},
  ]},
  {icon:'ğŸ“', title:'è¡¥å……ï¼šIssue ç¬”è®°', items:[
    {n:'A1', files:['notes/llama.cpp/sched-issue.md'], desc:'è°ƒåº¦é—®é¢˜'},
    {n:'A2', files:['notes/llama.cpp/update_chat_msg-issue.md'], desc:'chat æ¶ˆæ¯æ›´æ–°é—®é¢˜'},
  ]},
];

const STORAGE_KEY = 'llama-roadmap-progress';
const STREAK_KEY  = 'llama-roadmap-streak';

function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
function save(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function loadStreak() { try { return JSON.parse(localStorage.getItem(STREAK_KEY)) || {dates:[]}; } catch { return {dates:[]}; } }
function saveStreak(s) { localStorage.setItem(STREAK_KEY, JSON.stringify(s)); }

function todayStr() { return new Date().toISOString().slice(0,10); }

function recordToday() {
  const s = loadStreak();
  const t = todayStr();
  if (!s.dates.includes(t)) { s.dates.push(t); s.dates.sort(); saveStreak(s); }
  updateStreak();
}

function calcStreak() {
  const s = loadStreak();
  if (!s.dates.length) return 0;
  let streak = 0;
  let d = new Date(); d.setHours(0,0,0,0);
  const tStr = todayStr();
  if (!s.dates.includes(tStr)) d.setDate(d.getDate() - 1);
  while (true) {
    const ds = d.toISOString().slice(0,10);
    if (s.dates.includes(ds)) { streak++; d.setDate(d.getDate()-1); } else break;
  }
  return streak;
}

function updateStreak() {
  document.getElementById('streakCount').textContent = calcStreak();
  const cal = document.getElementById('streakCal');
  cal.innerHTML = '';
  const s = loadStreak();
  const t = todayStr();
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().slice(0,10);
    const el = document.createElement('div');
    el.className = 'streak-day' + (s.dates.includes(ds) ? ' active' : '') + (ds === t ? ' today' : '');
    el.title = ds;
    cal.appendChild(el);
  }
}

function render() {
  const data = load();
  const container = document.getElementById('phases');
  container.innerHTML = '';
  let totalDone = 0, totalAll = 0;

  PHASES.forEach((phase, pi) => {
    const div = document.createElement('div');
    div.className = 'phase' + (pi < 2 ? ' open' : '');
    let phaseDone = 0;

    let itemsHtml = '';
    phase.items.forEach(item => {
      totalAll++;
      const key = 'item-' + item.n;
      const checked = data[key]?.done || false;
      const doneDate = data[key]?.date || '';
      if (checked) { phaseDone++; totalDone++; }
      const filesHtml = item.files.map(f => `<a href="${REPO}${f}" target="_blank">${f.split('/').pop()}</a>`).join(' / ');
      const animBtn = item.anim ? `<button class="anim-btn" onclick="event.stopPropagation();openViz();">â–¶ åŠ¨ç”»</button>` : '';
      itemsHtml += `
        <div class="item ${checked?'checked':''}">
          <input type="checkbox" ${checked?'checked':''} data-key="${key}">
          <span class="item-num">#${item.n}</span>
          <div class="item-content">
            <div class="item-file">${filesHtml}${animBtn}</div>
            <div class="item-desc">${item.desc}</div>
            ${doneDate ? `<div class="item-date">âœ… ${doneDate}</div>` : ''}
          </div>
        </div>`;
    });

    const badgeClass = phaseDone === phase.items.length ? 'done' : '';
    const pct = phase.items.length ? Math.round(phaseDone / phase.items.length * 100) : 0;

    div.innerHTML = `
      <div class="phase-header" onclick="this.parentElement.classList.toggle('open')">
        <span class="phase-icon">${phase.icon}</span>
        <span class="phase-title">${phase.title}</span>
        <span class="phase-badge ${badgeClass}">${phaseDone}/${phase.items.length}</span>
        <span class="phase-arrow">â–¶</span>
      </div>
      <div class="phase-progress"><div class="phase-progress-fill" style="width:${pct}%"></div></div>
      <div class="phase-body">${itemsHtml}</div>`;
    container.appendChild(div);
  });

  const pct = totalAll ? Math.round(totalDone / totalAll * 100) : 0;
  document.getElementById('overallFill').style.width = pct + '%';
  document.getElementById('overallText').textContent = `${totalDone} / ${totalAll} å®Œæˆ (${pct}%)`;
  document.getElementById('statDone').textContent = totalDone;
  document.getElementById('statTodo').textContent = totalAll - totalDone;
  document.getElementById('statDays').textContent = totalAll - totalDone;

  document.querySelectorAll('.item input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      const d = load();
      const key = this.dataset.key;
      if (this.checked) { d[key] = { done: true, date: todayStr() }; recordToday(); }
      else delete d[key];
      save(d);
      render();
    });
  });

  updateStreak();
}

function expandAll() { document.querySelectorAll('.phase').forEach(p => p.classList.add('open')); }
function collapseAll() { document.querySelectorAll('.phase').forEach(p => p.classList.remove('open')); }

function exportProgress() {
  const d = { progress: load(), streak: loadStreak() };
  const blob = new Blob([JSON.stringify(d, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'llama-roadmap-progress.json';
  a.click();
}

function importProgress() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try { const d = JSON.parse(ev.target.result); if (d.progress) save(d.progress); if (d.streak) saveStreak(d.streak); render(); alert('å¯¼å…¥æˆåŠŸï¼'); }
      catch { alert('JSON æ ¼å¼é”™è¯¯'); }
    };
    r.readAsText(f);
  };
  input.click();
}

function resetAll() {
  if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(STREAK_KEY);
  render();
}

// ========== Visualization ==========
const VIZ_STEPS = [
  {
    title: "è¾“å…¥æ–‡æœ¬ â†’ å­—ç¬¦æ•°ç»„",
    desc: "è¾“å…¥æ–‡æœ¬ <code>\"hello\"</code> è¢«æ‹†åˆ†ä¸º UTF-8 å­—ç¬¦ã€‚æ¯ä¸ªå­—ç¬¦å­˜å…¥ <code>llm_symbol</code> ç»“æ„ï¼Œå½¢æˆæ•°ç»„ã€‚ä½¿ç”¨ <code>unicode_len_utf8()</code> åˆ¤æ–­æ¯ä¸ªå­—ç¬¦çš„å­—èŠ‚é•¿åº¦ã€‚",
    code: `<span class="line">text = "hello"</span>
<span class="line hl">for each char in text:</span>
<span class="line hl">    symbols.push({text: char, n: len(char)})</span>`,
    cells: [
      {char:'h',idx:0},{char:'e',idx:1},{char:'l',idx:2},{char:'l',idx:3},{char:'o',idx:4}
    ],
    highlight: [],
    queue: [],
    showQueue: false
  },
  {
    title: "æ„å»ºåŒå‘é“¾è¡¨",
    desc: "ä¸ºæ¯ä¸ª symbol è®¾ç½® <code>prev</code> å’Œ <code>next</code> æŒ‡é’ˆã€‚é¦–å…ƒç´  prev=-1ï¼Œæœ«å…ƒç´  next=-1ã€‚è¿™æ ·å¯ä»¥é€šè¿‡ä¿®æ”¹æŒ‡é’ˆæ¥'åˆ é™¤'å…ƒç´ ï¼Œè€Œæ— éœ€ç§»åŠ¨å†…å­˜æ•°æ®ã€‚",
    code: `<span class="line hl">symbols[0] = {char:'h', prev:-1, next:1}</span>
<span class="line hl">symbols[1] = {char:'e', prev:0,  next:2}</span>
<span class="line">symbols[2] = {char:'l', prev:1,  next:3}</span>
<span class="line">// ...</span>`,
    cells: [
      {char:'h',idx:0,ptr:'-1,1'},{char:'e',idx:1,ptr:'0,2'},{char:'l',idx:2,ptr:'1,3'},{char:'l',idx:3,ptr:'2,4'},{char:'o',idx:4,ptr:'3,-1'}
    ],
    highlight: [0,1,2,3,4],
    queue: [],
    showQueue: false
  },
  {
    title: "æ‰«ææ‰€æœ‰ç›¸é‚»å¯¹ï¼ŒåŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—",
    desc: "éå†é“¾è¡¨ï¼Œå¯¹æ¯å¯¹ç›¸é‚»å­—ç¬¦è°ƒç”¨ <code>try_add_bigram(i-1, i)</code>ã€‚å¦‚æœåœ¨ <code>bpe_ranks</code> ä¸­æ‰¾åˆ°è¯¥å¯¹ï¼Œåˆ™åˆ›å»º bigram åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—ã€‚<code>rank</code> å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼ˆè®­ç»ƒæ—¶å‡ºç°é¢‘ç‡è¶Šé«˜ï¼‰ã€‚",
    code: `<span class="line hl">for i in 1..n:</span>
<span class="line hl">    rank = bpe_ranks.find(s[i-1], s[i])</span>
<span class="line">    if rank >= 0:</span>
<span class="line">        queue.push({left:i-1, right:i, rank})</span>`,
    cells: [
      {char:'h',idx:0},{char:'e',idx:1,highlight:true},{char:'l',idx:2,highlight:true},{char:'l',idx:3,highlight:true},{char:'o',idx:4,highlight:true}
    ],
    highlight: [1,2,3],
    queue: [{text:'l+l',rank:5,top:true},{text:'l+o',rank:12}],
    showQueue: true
  },
  {
    title: "å¼¹å‡º rank æœ€å°çš„ bigram å¹¶åˆå¹¶",
    desc: "ä»é˜Ÿåˆ—å¼¹å‡º <code>l+l (rank=5)</code>ã€‚å°†å³ä¾§ symbol åˆå¹¶åˆ°å·¦ä¾§ï¼š<code>left.n += right.n</code>ï¼Œ<code>right.n = 0</code> æ ‡è®°åˆ é™¤ã€‚æ›´æ–°é“¾è¡¨æŒ‡é’ˆè·³è¿‡å·²åˆ é™¤èŠ‚ç‚¹ã€‚",
    code: `<span class="line hl">bigram = queue.pop()  // l+l, rank=5</span>
<span class="line hl">symbols[2].n += symbols[3].n  // "ll"</span>
<span class="line hl">symbols[3].n = 0  // deleted</span>
<span class="line">symbols[2].next = symbols[3].next</span>`,
    cells: [
      {char:'h',idx:0},{char:'e',idx:1},{char:'ll',idx:2,merged:true},{char:'Ã—',idx:3,deleted:true},{char:'o',idx:4}
    ],
    highlight: [2],
    queue: [{text:'l+l',rank:5,done:true},{text:'l+o',rank:12}],
    showQueue: true
  },
  {
    title: "æ·»åŠ æ–°çš„ç›¸é‚» bigram",
    desc: "åˆå¹¶åäº§ç”Ÿæ–°çš„ç›¸é‚»å¯¹ï¼š<code>e-ll</code> å’Œ <code>ll-o</code>ã€‚æ£€æŸ¥å®ƒä»¬æ˜¯å¦åœ¨ <code>bpe_ranks</code> ä¸­ï¼Œè‹¥å­˜åœ¨åˆ™åŠ å…¥é˜Ÿåˆ—ã€‚ç»§ç»­å¾ªç¯ç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºã€‚",
    code: `<span class="line hl">add_bigran(symbols[2].prev, 2)  // e-ll</span>
<span class="line hl">add_bigrak(2, symbols[2].next)   // ll-o</span>
<span class="line">// ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ª bigram</span>`,
    cells: [
      {char:'h',idx:0},{char:'e',idx:1,highlight:true},{char:'ll',idx:2,merged:true,highlight:true},{char:'Ã—',idx:3,deleted:true},{char:'o',idx:4,highlight:true}
    ],
    highlight: [1,2,4],
    queue: [{text:'e+ll',rank:8,top:true},{text:'ll+o',rank:15}],
    showQueue: true
  },
  {
    title: "éå†é“¾è¡¨ï¼Œè¾“å‡º Token ID",
    desc: "BPE åˆå¹¶å®Œæˆåï¼Œä»é“¾è¡¨å¤´å¼€å§‹éå†ã€‚å¯¹æ¯ä¸ª symbol è°ƒç”¨ <code>token_to_id</code> æŸ¥æ‰¾å¯¹åº”çš„ token IDã€‚æœ€ç»ˆè¾“å‡º token ID åºåˆ—ï¼Œé€å…¥æ¨¡å‹è¿›è¡Œæ¨ç†ã€‚",
    code: `<span class="line hl">for i in linked_list:</span>
<span class="line hl">    token_id = token_to_id[symbols[i].text]</span>
<span class="line">    output.append(token_id)</span>`,
    cells: [
      {char:'h',idx:0,highlight:true},{char:'e',idx:1,highlight:true},{char:'ll',idx:2,merged:true,highlight:true},{char:'Ã—',idx:3,deleted:true},{char:'o',idx:4,highlight:true}
    ],
    highlight: [0,1,2,4],
    queue: [],
    showQueue: false,
    output: "[104, 101, 267, 111]"
  }
];

let vizStep = 0;
let vizPlaying = false;
let vizTimer = null;

function openViz() {
  vizStep = 0;
  vizPlaying = false;
  renderViz();
  document.getElementById('vizModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeViz() {
  document.getElementById('vizModal').classList.remove('open');
  document.body.style.overflow = '';
  if (vizTimer) { clearTimeout(vizTimer); vizTimer = null; }
  vizPlaying = false;
}

function renderViz() {
  const step = VIZ_STEPS[vizStep];
  document.getElementById('vizStepNum').textContent = `STEP ${vizStep + 1}/${VIZ_STEPS.length}`;
  document.getElementById('vizStepTitle').textContent = step.title;
  document.getElementById('vizDesc').innerHTML = step.desc;
  document.getElementById('vizCode').innerHTML = step.code;

  // Render cells
  const arr = document.getElementById('vizArray');
  arr.innerHTML = '';
  step.cells.forEach((c, i) => {
    if (c.deleted) {
      arr.innerHTML += `<div class="viz-cell deleted"><div class="viz-char">Ã—</div><div class="viz-idx">${c.idx}</div></div>`;
    } else {
      const hl = step.highlight.includes(i) ? ' highlight' : '';
      const mg = c.merged ? ' merged' : '';
      const proc = c.highlight ? ' proc' : '';
      arr.innerHTML += `<div class="viz-cell${hl}${mg}${proc}"><div class="viz-idx">${c.idx}</div><div class="viz-char">${c.char}</div>${c.ptr ? `<div class="viz-ptr">${c.ptr}</div>` : ''}</div>`;
    }
    if (i < step.cells.length - 1) {
      const hidden = step.cells[i].deleted || step.cells[i+1].deleted;
      arr.innerHTML += `<div class="viz-arrow${hidden ? ' hidden' : ''}">â†’</div>`;
    }
  });

  // Queue
  const qb = document.getElementById('vizQueueBox');
  const q = document.getElementById('vizQueue');
  if (step.showQueue && step.queue.length) {
    qb.style.display = 'block';
    q.innerHTML = step.queue.map(item => {
      let cls = 'viz-queue-item';
      if (item.top) cls += ' top';
      if (item.done) cls += ' done';
      return `<span class="${cls}">${item.text}(${item.rank})</span>`;
    }).join('');
  } else {
    qb.style.display = 'none';
  }

  // Output
  const ob = document.getElementById('vizOutputBox');
  if (step.output) {
    ob.style.display = 'block';
    document.getElementById('vizOutput').textContent = step.output;
  } else {
    ob.style.display = 'none';
  }

  // Progress
  const pct = ((vizStep + 1) / VIZ_STEPS.length) * 100;
  document.getElementById('vizProgressFill').style.width = pct + '%';
  document.getElementById('vizProgressText').textContent = `${vizStep + 1} / ${VIZ_STEPS.length}`;

  // Buttons
  document.getElementById('vizPrevBtn').disabled = vizStep === 0;
  document.getElementById('vizNextBtn').disabled = vizStep === VIZ_STEPS.length - 1;
  document.getElementById('vizPlayBtn').textContent = vizPlaying ? 'â¸' : 'â–¶';
}

function vizNext() {
  if (vizStep < VIZ_STEPS.length - 1) { vizStep++; renderViz(); }
  else if (vizPlaying) { vizPlaying = false; renderViz(); }
}

function vizPrev() {
  if (vizStep > 0) { vizStep--; renderViz(); }
}

function vizTogglePlay() {
  vizPlaying = !vizPlaying;
  renderViz();
  if (vizPlaying) runViz();
}

function runViz() {
  if (!vizPlaying) return;
  if (vizStep < VIZ_STEPS.length - 1) {
    vizTimer = setTimeout(() => { vizNext(); runViz(); }, 2500);
  } else {
    vizPlaying = false;
    renderViz();
  }
}

function vizSeek(e) {
  const rect = e.target.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const pct = x / rect.width;
  vizStep = Math.floor(pct * VIZ_STEPS.length);
  vizStep = Math.max(0, Math.min(VIZ_STEPS.length - 1, vizStep));
  renderViz();
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeViz(); });
document.getElementById('vizModal').addEventListener('click', e => { if (e.target.id === 'vizModal') closeViz(); });

render();
</script>
</body>
</html>
