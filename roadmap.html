<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>llama.cpp å­¦ä¹ è·¯çº¿å›¾</title>
<style>
  :root {
    --bg: #0d1117; --card: #161b22; --border: #30363d;
    --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff;
    --green: #3fb950; --yellow: #d29922; --purple: #bc8cff;
    --red: #f85149; --orange: #f0883e;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }

  .container { max-width: 960px; margin: 0 auto; padding: 24px 16px; }

  header { text-align: center; padding: 40px 0 32px; }
  header h1 { font-size: 2em; margin-bottom: 8px; }
  header h1 span { color: var(--accent); }
  header p { color: var(--muted); font-size: 0.95em; }

  /* Overall progress */
  .overall { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px 24px; margin-bottom: 32px; }
  .overall h2 { font-size: 1.1em; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .overall h2 .emoji { font-size: 1.3em; }
  .progress-bar { background: var(--border); border-radius: 8px; height: 20px; overflow: hidden; position: relative; }
  .progress-fill { height: 100%; border-radius: 8px; background: linear-gradient(90deg, var(--green), var(--accent)); transition: width 0.5s ease; }
  .progress-text { text-align: center; margin-top: 8px; color: var(--muted); font-size: 0.9em; }
  .stats { display: flex; gap: 24px; margin-top: 16px; flex-wrap: wrap; }
  .stat { display: flex; align-items: center; gap: 6px; font-size: 0.85em; color: var(--muted); }
  .stat .dot { width: 10px; height: 10px; border-radius: 50%; }

  /* Streak */
  .streak-bar { display: flex; align-items: center; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .streak-bar .fire { font-size: 1.4em; }
  .streak-info { font-size: 0.85em; color: var(--muted); }
  .streak-info strong { color: var(--orange); font-size: 1.1em; }
  .streak-cal { display: flex; gap: 3px; margin-left: auto; }
  .streak-day { width: 14px; height: 14px; border-radius: 3px; background: var(--border); }
  .streak-day.active { background: var(--green); }
  .streak-day.today { outline: 2px solid var(--accent); }

  /* Phase */
  .phase { background: var(--card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
  .phase-header { padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; user-select: none; }
  .phase-header:hover { background: rgba(88,166,255,0.05); }
  .phase-icon { font-size: 1.3em; }
  .phase-title { flex: 1; font-size: 1em; font-weight: 600; }
  .phase-badge { font-size: 0.75em; padding: 2px 10px; border-radius: 12px; background: var(--border); color: var(--muted); }
  .phase-badge.done { background: rgba(63,185,80,0.15); color: var(--green); }
  .phase-arrow { color: var(--muted); transition: transform 0.3s; font-size: 0.8em; }
  .phase.open .phase-arrow { transform: rotate(90deg); }
  .phase-progress { height: 3px; background: var(--border); }
  .phase-progress-fill { height: 100%; background: var(--green); transition: width 0.4s; }
  .phase-body { display: none; padding: 0 20px 16px; }
  .phase.open .phase-body { display: block; }

  /* Item */
  .item { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .item:last-child { border-bottom: none; }
  .item input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; margin-top: 2px; position: relative; transition: all 0.2s; }
  .item input[type="checkbox"]:checked { background: var(--green); border-color: var(--green); }
  .item input[type="checkbox"]:checked::after { content: 'âœ“'; position: absolute; top: -1px; left: 3px; color: #fff; font-size: 14px; font-weight: bold; }
  .item-num { color: var(--accent); font-weight: 700; font-size: 0.85em; min-width: 28px; margin-top: 2px; }
  .item-content { flex: 1; }
  .item-file { font-size: 0.85em; color: var(--purple); word-break: break-all; }
  .item-file a { color: var(--purple); text-decoration: none; }
  .item-file a:hover { text-decoration: underline; }
  .item-desc { font-size: 0.85em; color: var(--muted); margin-top: 2px; }
  .item.checked .item-file a { color: var(--muted); text-decoration: line-through; }
  .item.checked .item-desc { text-decoration: line-through; opacity: 0.6; }
  .item-date { font-size: 0.7em; color: var(--muted); margin-top: 4px; }

  /* Buttons */
  .actions { text-align: center; margin: 24px 0; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
  .btn { padding: 8px 20px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.danger:hover { border-color: var(--red); color: var(--red); }

  footer { text-align: center; padding: 32px 0; color: var(--muted); font-size: 0.8em; }

  /* Animation Modal Styles */
  .anim-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
  .anim-modal.open { display: flex; }
  .anim-content { background: var(--card); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
  .anim-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
  .anim-header h3 { font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
  .anim-close { background: none; border: none; color: var(--muted); font-size: 1.5em; cursor: pointer; padding: 4px 8px; line-height: 1; }
  .anim-close:hover { color: var(--text); }
  .anim-body { flex: 1; overflow-y: auto; padding: 20px; }

  /* Animation Stage */
  .anim-stage { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 16px; min-height: 180px; overflow-x: auto; }
  .anim-title { font-size: 0.85em; color: var(--muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
  .linked-list { display: flex; align-items: center; gap: 8px; min-width: max-content; padding: 20px 10px; }
  .ll-node { background: var(--card); border: 2px solid var(--border); border-radius: 10px; padding: 12px 16px; text-align: center; min-width: 70px; transition: all 0.4s ease; position: relative; }
  .ll-node.active { border-color: var(--accent); box-shadow: 0 0 20px rgba(88,166,255,0.3); }
  .ll-node.merged { border-color: var(--green); background: rgba(63,185,80,0.1); }
  .ll-node .char { font-size: 1.4em; font-weight: 700; color: var(--text); }
  .ll-node .meta { font-size: 0.7em; color: var(--muted); margin-top: 4px; font-family: monospace; }
  .ll-arrow { color: var(--accent); font-size: 1.2em; opacity: 0.6; }
  .ll-arrow.inactive { opacity: 0.15; }

  /* Queue visualization */
  .queue-area { margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border); }
  .queue-items { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .queue-item { background: var(--border); padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-family: monospace; }
  .queue-item.top { background: var(--accent); color: #000; }
  .queue-item.done { opacity: 0.4; text-decoration: line-through; }

  /* Description */
  .anim-desc { background: rgba(88,166,255,0.08); border: 1px solid rgba(88,166,255,0.2); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
  .anim-desc h4 { font-size: 0.95em; margin-bottom: 8px; color: var(--accent); }
  .anim-desc p { font-size: 0.85em; color: var(--text); line-height: 1.6; margin: 0; }

  /* Code block */
  .anim-code { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .anim-code pre { margin: 0; padding: 16px; overflow-x: auto; font-size: 0.8em; line-height: 1.5; }
  .anim-code code { font-family: 'JetBrains Mono', 'Fira Code', monospace; color: var(--muted); }
  .anim-code .line { display: block; padding: 2px 8px; margin: 0 -8px; border-radius: 4px; }
  .anim-code .line.hl { background: rgba(88,166,255,0.15); color: var(--text); }
  .anim-code .keyword { color: var(--purple); }
  .anim-code .string { color: var(--green); }
  .anim-code .comment { color: var(--muted); font-style: italic; }
  .anim-code .number { color: var(--orange); }

  /* Navigation */
  .anim-nav { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 16px 20px; border-top: 1px solid var(--border); }
  .anim-nav button { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
  .anim-nav button:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .anim-nav button:disabled { opacity: 0.4; cursor: not-allowed; }
  .step-dots { display: flex; gap: 6px; }
  .step-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border); cursor: pointer; transition: all 0.2s; }
  .step-dot.active { background: var(--accent); transform: scale(1.2); }
  .step-dot:hover { background: var(--muted); }
  .step-counter { font-size: 0.8em; color: var(--muted); }

  /* Animation button in items */
  .anim-btn { background: linear-gradient(135deg, var(--accent), var(--purple)); border: none; color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.75em; cursor: pointer; margin-left: 8px; transition: transform 0.2s, box-shadow 0.2s; }
  .anim-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88,166,255,0.3); }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ğŸ¦™ <span>llama.cpp</span> å­¦ä¹ è·¯çº¿å›¾</h1>
    <p>46 ä¸ªçŸ¥è¯†ç‚¹ Â· 10 ä¸ªé˜¶æ®µ Â· ä»åŸºç¡€åˆ° Agent å…¨è¦†ç›–</p>
  </header>

  <div class="overall">
    <h2><span class="emoji">ğŸ“Š</span> æ€»ä½“è¿›åº¦</h2>
    <div class="progress-bar"><div class="progress-fill" id="overallFill" style="width:0%"></div></div>
    <div class="progress-text" id="overallText">0 / 48 å®Œæˆ (0%)</div>
    <div class="stats">
      <div class="stat"><span class="dot" style="background:var(--green)"></span> <span id="statDone">0</span> å·²å®Œæˆ</div>
      <div class="stat"><span class="dot" style="background:var(--border)"></span> <span id="statTodo">48</span> å¾…å­¦ä¹ </div>
      <div class="stat"><span class="dot" style="background:var(--accent)"></span> é¢„è®¡ <span id="statDays">48</span> å¤©</div>
    </div>
    <div class="streak-bar">
      <span class="fire">ğŸ”¥</span>
      <div class="streak-info">è¿ç»­å­¦ä¹  <strong id="streakCount">0</strong> å¤©</div>
      <div class="streak-cal" id="streakCal"></div>
    </div>
  </div>

  <div id="phases"></div>

  <div class="actions">
    <button class="btn" onclick="expandAll()">å±•å¼€å…¨éƒ¨</button>
    <button class="btn" onclick="collapseAll()">æŠ˜å å…¨éƒ¨</button>
    <button class="btn" onclick="exportProgress()">å¯¼å‡ºè¿›åº¦ JSON</button>
    <button class="btn" onclick="importProgress()">å¯¼å…¥è¿›åº¦</button>
    <button class="btn danger" onclick="resetAll()">é‡ç½®è¿›åº¦</button>
  </div>

  <footer>æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorage Â· åŸºäº <a href="https://github.com/blime4/learning-ai" style="color:var(--accent)">learning-ai</a> ä»“åº“</footer>
</div>

<!-- Animation Modal -->
<div class="anim-modal" id="animModal">
  <div class="anim-content">
    <div class="anim-header">
      <h3>ğŸ¬ BPE åˆ†è¯åŠ¨ç”»è®²è§£</h3>
      <button class="anim-close" onclick="closeAnimModal()">&times;</button>
    </div>
    <div class="anim-body">
      <div class="anim-stage">
        <div class="anim-title">é“¾è¡¨å¯è§†åŒ– (llm_symbol)</div>
        <div class="linked-list" id="animLinkedList"></div>
        <div class="queue-area" id="animQueueArea" style="display:none;">
          <div class="anim-title">ä¼˜å…ˆé˜Ÿåˆ— (work_queue)</div>
          <div class="queue-items" id="animQueue"></div>
        </div>
      </div>
      <div class="anim-desc">
        <h4 id="animStepTitle">æ­¥éª¤æ ‡é¢˜</h4>
        <p id="animStepDesc">æ­¥éª¤æè¿°</p>
      </div>
      <div class="anim-code">
        <pre><code id="animCode"></code></pre>
      </div>
    </div>
    <div class="anim-nav">
      <button id="animPrevBtn" onclick="animPrev()">â—€ ä¸Šä¸€æ­¥</button>
      <div class="step-dots" id="animDots"></div>
      <span class="step-counter" id="animCounter">1 / 8</span>
      <button id="animNextBtn" onclick="animNext()">ä¸‹ä¸€æ­¥ â–¶</button>
    </div>
  </div>
</div>

<script>
const REPO = 'https://github.com/blime4/learning-ai/blob/main/';
const PHASES = [
  {icon:'ğŸ—ï¸', title:'ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ä¸ç¯å¢ƒæ­å»º', items:[
    {n:'1', files:['fundamentals/ggml/README.md'], desc:'GGML åº•å±‚å¼ é‡åº“ â€” tensorã€backendã€è®¡ç®—å›¾'},
    {n:'2', files:['fundamentals/llama.cpp/README.md'], desc:'é¡¹ç›®å…¥å£ï¼šå­æ¨¡å—é…ç½®ã€ç¼–è¯‘ã€GDB è°ƒè¯•ã€CUDA æ„å»º'},
    {n:'3', files:['notes/llama.cpp/debugging.md'], desc:'è°ƒè¯•æŠ€å·§'},
  ]},
  {icon:'âš™ï¸', title:'ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¦‚å¿µï¼ˆæ¨ç†æµæ°´çº¿ï¼‰', items:[
    {n:'4', files:['fundamentals/llama.cpp/src/tokenize.cpp','notes/llama.cpp/llama-vocab-notes.md'], desc:'åˆ†è¯å™¨ â€” æ¨ç†çš„ç¬¬ä¸€æ­¥', anim:'bpe'},
    {n:'5', files:['fundamentals/llama.cpp/src/simple-prompt.cpp'], desc:'æœ€ç®€å•çš„æ¨ç†ç¤ºä¾‹'},
    {n:'6', files:['notes/llama.cpp/llama-batch.md'], desc:'llama_batch / llama_ubatch ç»“æ„'},
    {n:'7', files:['notes/llama.cpp/process_ubatch.md'], desc:'micro-batch å¤„ç†ç»†èŠ‚'},
    {n:'8', files:['notes/llama.cpp/kv-cache.md'], desc:'KV ç¼“å­˜æœºåˆ¶ â€” æ¨ç†åŠ é€Ÿæ ¸å¿ƒ'},
    {n:'9', files:['fundamentals/llama.cpp/src/kv-cache.cpp'], desc:'KV ç¼“å­˜ä»£ç å®è·µ'},
    {n:'10', files:['notes/llama.cpp/graph-inputs.md'], desc:'è®¡ç®—å›¾è¾“å…¥æ„å»º'},
    {n:'11', files:['notes/llama.cpp/gpu-sampling.md'], desc:'GPU é‡‡æ ·ï¼ˆtemperatureã€top-kã€top-pï¼‰'},
    {n:'12', files:['notes/llama.cpp/output_ids.md'], desc:'è¾“å‡º token ID å¤„ç†'},
    {n:'13', files:['fundamentals/llama.cpp/src/simple-prompt-multi.cpp'], desc:'å¤š prompt æ‰¹å¤„ç†'},
  ]},
  {icon:'ğŸš€', title:'ç¬¬ä¸‰é˜¶æ®µï¼šGPU åŠ é€Ÿä¸åç«¯', items:[
    {n:'14', files:['notes/llama.cpp/cuda.md'], desc:'CUDA åç«¯åŠ è½½æœºåˆ¶'},
    {n:'15', files:['notes/llama.cpp/cuda-mul-mat.md'], desc:'CUDA çŸ©é˜µä¹˜æ³•'},
    {n:'16', files:['notes/llama.cpp/cuda-fp16-release-build-issue.md'], desc:'FP16 æ„å»ºé—®é¢˜'},
    {n:'17', files:['fundamentals/ggml/src/llama-att-softmax.cpp'], desc:'attention softmax GGML å®ç°'},
    {n:'18', files:['notes/llama.cpp/flash-attn-misalignment-issue.md'], desc:'Flash Attention å¯¹é½é—®é¢˜'},
    {n:'19', files:['notes/llama.cpp/macosx.md'], desc:'macOS (Metal) å¹³å°'},
    {n:'20', files:['notes/llama.cpp/ggml-threadpool-macos-issue.md'], desc:'çº¿ç¨‹æ± é—®é¢˜'},
  ]},
  {icon:'ğŸ“¦', title:'ç¬¬å››é˜¶æ®µï¼šæ¨¡å‹è½¬æ¢ä¸é‡åŒ–', items:[
    {n:'21', files:['notes/llama.cpp/convert.md'], desc:'convert_hf_to_gguf.py æµç¨‹'},
    {n:'22', files:['notes/llama.cpp/quantization.md'], desc:'é‡åŒ–åŸç†ä¸ QAT'},
    {n:'23', files:['notes/llama.cpp/convert-dequantize.md'], desc:'åé‡åŒ–è¿‡ç¨‹'},
    {n:'24', files:['notes/llama.cpp/devstral2-conversion.md'], desc:'Devstral2 è½¬æ¢å®ä¾‹'},
    {n:'25', files:['notes/llama.cpp/convert-mamba-issue.md'], desc:'Mamba è½¬æ¢é—®é¢˜'},
    {n:'26', files:['notes/llama.cpp/gemma-bos-issue.md'], desc:'Gemma BOS token é—®é¢˜'},
  ]},
  {icon:'ğŸ”¢', title:'ç¬¬äº”é˜¶æ®µï¼šEmbeddings', items:[
    {n:'27', files:['fundamentals/llama.cpp/src/embeddings.cpp'], desc:'embedding ç”Ÿæˆä»£ç '},
    {n:'28', files:['notes/llama.cpp/embeddings-presets.md'], desc:'embedding é¢„è®¾é…ç½®'},
  ]},
  {icon:'ğŸŒ', title:'ç¬¬å…­é˜¶æ®µï¼šServer ä¸éƒ¨ç½²', items:[
    {n:'29', files:['notes/llama.cpp/llama-server.md'], desc:'server å¯åŠ¨ä¸ API'},
    {n:'30', files:['notes/llama.cpp/server-checkpoints.md'], desc:'checkpoint ç®¡ç†'},
    {n:'31', files:['notes/llama.cpp/server-logprob-issue.md'], desc:'log probability é—®é¢˜'},
    {n:'32', files:['notes/llama.cpp/server-unit-tests.md'], desc:'server æµ‹è¯•'},
    {n:'33', files:['notes/llama.cpp/llama-perplexity.md'], desc:'å›°æƒ‘åº¦è®¡ç®—'},
    {n:'34', files:['notes/llama.cpp/tests.md'], desc:'æµ‹è¯•æ¡†æ¶'},
    {n:'35', files:['notes/llama.cpp/sbatch.md'], desc:'SLURM æ‰¹é‡æäº¤'},
  ]},
  {icon:'ğŸ¯', title:'ç¬¬ä¸ƒé˜¶æ®µï¼šFinetuning', items:[
    {n:'36', files:['fundamentals/llama.cpp/README.md'], desc:'LoRA å¾®è°ƒã€Shakespeareã€chat æ ¼å¼è®­ç»ƒ'},
  ]},
  {icon:'ğŸ‘ï¸', title:'ç¬¬å…«é˜¶æ®µï¼šå¤šæ¨¡æ€ä¸ç‰¹æ®Šæ¨¡å‹', items:[
    {n:'37', files:['notes/llama.cpp/llama-3-2-vision.md'], desc:'Llama 3.2 è§†è§‰æ¨¡å‹'},
    {n:'38', files:['notes/llama.cpp/qwen-2.5VL-3B-instruct.md'], desc:'Qwen è§†è§‰æ¨¡å‹'},
    {n:'39', files:['notes/llama.cpp/vision-model-issue.md'], desc:'è§†è§‰æ¨¡å‹é—®é¢˜'},
    {n:'40', files:['fundamentals/image-processing/src/mllama.cpp'], desc:'Llama è§†è§‰æ¨¡å‹å®ç°'},
    {n:'41', files:['notes/llama.cpp/tts.md'], desc:'TTS é›†æˆ'},
  ]},
  {icon:'ğŸ¤–', title:'ç¬¬ä¹é˜¶æ®µï¼šAgent ä¸ä¸Šå±‚åº”ç”¨', items:[
    {n:'42', files:['agents/llama-cpp-agent/README.md'], desc:'WASM agent æ¡†æ¶'},
    {n:'43', files:['agents/llama-cpp-agent/agent/src/main.rs','agents/llama-cpp-agent/agent/src/agent.rs','agents/llama-cpp-agent/agent/src/tool.rs'], desc:'Rust agent å®ç°'},
  ]},
  {icon:'ğŸ”—', title:'ç¬¬åé˜¶æ®µï¼šå…¶ä»–è¯­è¨€ç»‘å®šä¸é›†æˆ', items:[
    {n:'44', files:['fundamentals/python/src/llama-chat-format.py'], desc:'Python chat æ ¼å¼'},
    {n:'45', files:['fundamentals/rust/llm-chains-llama-example/README.md'], desc:'Rust LLM chains + Llama'},
    {n:'46', files:['fundamentals/rust/llm-chains-chat-demo/src/main-llama.rs'], desc:'Rust chat demo'},
  ]},
  {icon:'ğŸ“', title:'è¡¥å……ï¼šIssue ç¬”è®°', items:[
    {n:'A1', files:['notes/llama.cpp/sched-issue.md'], desc:'è°ƒåº¦é—®é¢˜'},
    {n:'A2', files:['notes/llama.cpp/update_chat_msg-issue.md'], desc:'chat æ¶ˆæ¯æ›´æ–°é—®é¢˜'},
  ]},
];

const STORAGE_KEY = 'llama-roadmap-progress';
const STREAK_KEY  = 'llama-roadmap-streak';

function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
function save(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
function loadStreak() { try { return JSON.parse(localStorage.getItem(STREAK_KEY)) || {dates:[]}; } catch { return {dates:[]}; } }
function saveStreak(s) { localStorage.setItem(STREAK_KEY, JSON.stringify(s)); }

function todayStr() { return new Date().toISOString().slice(0,10); }

function recordToday() {
  const s = loadStreak();
  const t = todayStr();
  if (!s.dates.includes(t)) { s.dates.push(t); s.dates.sort(); saveStreak(s); }
  updateStreak();
}

function calcStreak() {
  const s = loadStreak();
  if (!s.dates.length) return 0;
  let streak = 0;
  let d = new Date(); d.setHours(0,0,0,0);
  // check if today is in dates
  const tStr = todayStr();
  if (!s.dates.includes(tStr)) {
    d.setDate(d.getDate() - 1);
  }
  while (true) {
    const ds = d.toISOString().slice(0,10);
    if (s.dates.includes(ds)) { streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  return streak;
}

function updateStreak() {
  document.getElementById('streakCount').textContent = calcStreak();
  // render last 14 days
  const cal = document.getElementById('streakCal');
  cal.innerHTML = '';
  const s = loadStreak();
  const t = todayStr();
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().slice(0,10);
    const el = document.createElement('div');
    el.className = 'streak-day' + (s.dates.includes(ds) ? ' active' : '') + (ds === t ? ' today' : '');
    el.title = ds;
    cal.appendChild(el);
  }
}

function render() {
  const data = load();
  const container = document.getElementById('phases');
  container.innerHTML = '';
  let totalDone = 0, totalAll = 0;

  PHASES.forEach((phase, pi) => {
    const div = document.createElement('div');
    div.className = 'phase' + (pi < 2 ? ' open' : '');
    let phaseDone = 0;

    let itemsHtml = '';
    phase.items.forEach(item => {
      totalAll++;
      const key = 'item-' + item.n;
      const checked = data[key]?.done || false;
      const doneDate = data[key]?.date || '';
      if (checked) { phaseDone++; totalDone++; }
      const filesHtml = item.files.map(f => `<a href="${REPO}${f}" target="_blank">${f.split('/').pop()}</a>`).join(' / ');
      const animBtn = item.anim ? `<button class="anim-btn" onclick="event.stopPropagation(); openAnimModal();">ğŸ¬ åŠ¨ç”»è®²è§£</button>` : '';
      itemsHtml += `
        <div class="item ${checked?'checked':''}">
          <input type="checkbox" ${checked?'checked':''} data-key="${key}">
          <span class="item-num">#${item.n}</span>
          <div class="item-content">
            <div class="item-file">${filesHtml}${animBtn}</div>
            <div class="item-desc">${item.desc}</div>
            ${doneDate ? `<div class="item-date">âœ… ${doneDate}</div>` : ''}
          </div>
        </div>`;
    });

    const badgeClass = phaseDone === phase.items.length ? 'done' : '';
    const pct = phase.items.length ? Math.round(phaseDone / phase.items.length * 100) : 0;

    div.innerHTML = `
      <div class="phase-header" onclick="this.parentElement.classList.toggle('open')">
        <span class="phase-icon">${phase.icon}</span>
        <span class="phase-title">${phase.title}</span>
        <span class="phase-badge ${badgeClass}">${phaseDone}/${phase.items.length}</span>
        <span class="phase-arrow">â–¶</span>
      </div>
      <div class="phase-progress"><div class="phase-progress-fill" style="width:${pct}%"></div></div>
      <div class="phase-body">${itemsHtml}</div>`;
    container.appendChild(div);
  });

  // Update overall
  const pct = totalAll ? Math.round(totalDone / totalAll * 100) : 0;
  document.getElementById('overallFill').style.width = pct + '%';
  document.getElementById('overallText').textContent = `${totalDone} / ${totalAll} å®Œæˆ (${pct}%)`;
  document.getElementById('statDone').textContent = totalDone;
  document.getElementById('statTodo').textContent = totalAll - totalDone;
  document.getElementById('statDays').textContent = totalAll - totalDone;

  // Bind checkboxes
  document.querySelectorAll('.item input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      const d = load();
      const key = this.dataset.key;
      if (this.checked) {
        d[key] = { done: true, date: todayStr() };
        recordToday();
      } else {
        delete d[key];
      }
      save(d);
      render();
    });
  });

  updateStreak();
}

function expandAll() { document.querySelectorAll('.phase').forEach(p => p.classList.add('open')); }
function collapseAll() { document.querySelectorAll('.phase').forEach(p => p.classList.remove('open')); }

function exportProgress() {
  const d = { progress: load(), streak: loadStreak() };
  const blob = new Blob([JSON.stringify(d, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'llama-roadmap-progress.json';
  a.click();
}

function importProgress() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if (d.progress) save(d.progress);
        if (d.streak) saveStreak(d.streak);
        render();
        alert('å¯¼å…¥æˆåŠŸï¼');
      } catch { alert('JSON æ ¼å¼é”™è¯¯'); }
    };
    r.readAsText(f);
  };
  input.click();
}

function resetAll() {
  if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(STREAK_KEY);
  render();
}

// ========== Animation Modal ==========
const ANIM_STEPS = [
  {
    title: "æ­¥éª¤ 1: UTF-8 å­—ç¬¦æ‹†åˆ†",
    desc: "å°†è¾“å…¥æ–‡æœ¬ 'hello' æ‹†åˆ†ä¸º UTF-8 å­—ç¬¦ã€‚æ¯ä¸ªå­—ç¬¦åˆ›å»ºä¸€ä¸ª llm_symbol ç»“æ„ï¼ŒåŒ…å« text æŒ‡é’ˆå’Œé•¿åº¦ nã€‚unicode_len_utf8() å‡½æ•°æ ¹æ®é¦–å­—èŠ‚åˆ¤æ–­å­—ç¬¦é•¿åº¦(1-4å­—èŠ‚)ã€‚",
    code: `<span class="line">while (offs < text.size()) {</span>
<span class="line hl">    sym.text = text.c_str() + offs;</span>
<span class="line hl">    sym.n = unicode_len_utf8(text[offs]);</span>
<span class="line">    offs += sym.n;</span>
<span class="line">    symbols.emplace_back(sym);</span>
<span class="line">}</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1},
      {text:'l',prev:1,next:3,idx:2},
      {text:'l',prev:2,next:4,idx:3},
      {text:'o',prev:3,next:-1,idx:4}
    ],
    active: [0,1,2,3,4],
    queue: [],
    showQueue: false
  },
  {
    title: "æ­¥éª¤ 2: æ„å»ºåŒå‘é“¾è¡¨",
    desc: "ä¸ºæ¯ä¸ª symbol è®¾ç½® prev å’Œ next æŒ‡é’ˆï¼Œå½¢æˆåŒå‘é“¾è¡¨ã€‚prev æŒ‡å‘å‰ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•ï¼Œnext æŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•ã€‚é¦–å…ƒç´ çš„ prev=-1ï¼Œæœ«å…ƒç´ çš„ next=-1ã€‚",
    code: `<span class="line">sym.prev = index - 1;</span>
<span class="line hl">sym.next = offs == text.size() ? -1 : index + 1;</span>
<span class="line">index++;</span>
<span class="line">symbols.emplace_back(sym);</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0,showPtr:true},
      {text:'e',prev:0,next:2,idx:1,showPtr:true},
      {text:'l',prev:1,next:3,idx:2,showPtr:true},
      {text:'l',prev:2,next:4,idx:3,showPtr:true},
      {text:'o',prev:3,next:-1,idx:4,showPtr:true}
    ],
    active: [0,1,2,3,4],
    queue: [],
    showQueue: false
  },
  {
    title: "æ­¥éª¤ 3: åˆå§‹åŒ– Bigram é˜Ÿåˆ—",
    desc: "éå†æ‰€æœ‰ç›¸é‚»å­—ç¬¦å¯¹ï¼Œè°ƒç”¨ try_add_bigram(i-1, i)ã€‚å¦‚æœè¿™å¯¹å­—ç¬¦åœ¨ bpe_ranks ä¸­å­˜åœ¨ï¼Œåˆ™åˆ›å»º bigram å¹¶åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—ã€‚é˜Ÿåˆ—æŒ‰ rank æ’åºï¼ˆå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ã€‚",
    code: `<span class="line hl">// seed the work queue with all possible 2-char tokens</span>
<span class="line hl">for (size_t i = 1; i < symbols.size(); ++i) {</span>
<span class="line hl">    try_add_bigram(i - 1, i);</span>
<span class="line">}</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1},
      {text:'l',prev:1,next:3,idx:2},
      {text:'l',prev:2,next:4,idx:3},
      {text:'o',prev:3,next:-1,idx:4}
    ],
    active: [1,2,3],  // æ­£åœ¨å¤„ç†çš„ç›¸é‚»å¯¹
    queue: ['l+l(rank=5)', 'l+o(rank=12)'],
    showQueue: true
  },
  {
    title: "æ­¥éª¤ 4: æŸ¥æ‰¾ BPE Rank",
    desc: "find_bpe_rank() åœ¨ bpe_ranks æ˜ å°„ä¸­æŸ¥æ‰¾å­—ç¬¦å¯¹çš„åˆå¹¶ä¼˜å…ˆçº§ã€‚rank å€¼è¶Šå°è¡¨ç¤ºè¯¥åˆå¹¶è§„åˆ™åœ¨è®­ç»ƒä¸­å‡ºç°é¢‘ç‡è¶Šé«˜ï¼Œåº”è¯¥ä¼˜å…ˆæ‰§è¡Œã€‚è¿™é‡Œ 'l'+'l' çš„ rank=5 æ˜¯æœ€å°çš„ã€‚",
    code: `<span class="line">auto it = bpe_ranks.find(std::make_pair(token_left, token_right));</span>
<span class="line">if (it == bpe_ranks.end()) return -1;</span>
<span class="line hl">return it->second;  // return rank</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1},
      {text:'l',prev:1,next:3,idx:2,active:true},
      {text:'l',prev:2,next:4,idx:3,active:true},
      {text:'o',prev:3,next:-1,idx:4}
    ],
    active: [2,3],
    queue: ['<span class="top">l+l(rank=5)</span>', 'l+o(rank=12)'],
    showQueue: true
  },
  {
    title: "æ­¥éª¤ 5: å¼¹å‡ºæœ€é«˜ä¼˜å…ˆçº§ Bigram",
    desc: "ä»ä¼˜å…ˆé˜Ÿåˆ—å¼¹å‡º rank æœ€å°çš„ bigramã€‚work_queue.top() è¿”å›é˜Ÿé¦–å…ƒç´ (l+l, rank=5)ï¼Œwork_queue.pop() å°†å…¶ç§»é™¤ã€‚è¿™æ˜¯ BPE ç®—æ³•çš„æ ¸å¿ƒï¼šæ€»æ˜¯å…ˆåˆå¹¶æœ€é«˜é¢‘çš„å­—ç¬¦å¯¹ã€‚",
    code: `<span class="line">while (!work_queue.empty()) {</span>
<span class="line hl">    auto bigram = work_queue.top();  // l+l, rank=5</span>
<span class="line hl">    work_queue.pop();</span>
<span class="line">    // ... process merge</span>
<span class="line">}</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1},
      {text:'l',prev:1,next:3,idx:2,active:true},
      {text:'l',prev:2,next:4,idx:3,active:true},
      {text:'o',prev:3,next:-1,idx:4}
    ],
    active: [2,3],
    queue: ['<span class="done">l+l(rank=5)</span>', 'l+o(rank=12)'],
    showQueue: true
  },
  {
    title: "æ­¥éª¤ 6: æ‰§è¡Œåˆå¹¶",
    desc: "å°†å³ä¾§ symbol åˆå¹¶åˆ°å·¦ä¾§ï¼šleft_symbol.n += right_symbol.nï¼ˆé•¿åº¦ç›¸åŠ ï¼‰ï¼Œright_symbol.n = 0ï¼ˆæ ‡è®°ä¸ºå·²åˆ é™¤ï¼‰ã€‚ç„¶åæ›´æ–°é“¾è¡¨æŒ‡é’ˆï¼šleft_symbol.next è·³è¿‡ rightï¼Œç›´æ¥æŒ‡å‘ right çš„ä¸‹ä¸€ä¸ªã€‚",
    code: `<span class="line hl">// merge the right sym into the left one</span>
<span class="line hl">left_symbol.n += right_symbol.n;  // "l" + "l" = "ll"</span>
<span class="line hl">right_symbol.n = 0;  // mark as deleted</span>
<span class="line">left_symbol.next = right_symbol.next;</span>
<span class="line">symbols[right_symbol.next].prev = bigram.left;</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1},
      {text:'ll',prev:1,next:4,idx:2,merged:true},
      {text:'',prev:2,next:4,idx:3,deleted:true},
      {text:'o',prev:2,next:-1,idx:4}
    ],
    active: [2],
    queue: ['l+o(rank=12)'],
    showQueue: true
  },
  {
    title: "æ­¥éª¤ 7: æ·»åŠ æ–° Bigram",
    desc: "åˆå¹¶åéœ€è¦æ£€æŸ¥æ–°äº§ç”Ÿçš„ç›¸é‚»å¯¹ã€‚è°ƒç”¨ add_new_bigram(left_symbol.prev, bigram.left) æ·»åŠ å·¦ä¾§æ–°å¯¹(e-ll)ï¼Œadd_new_bigram(bigram.left, left_symbol.next) æ·»åŠ å³ä¾§æ–°å¯¹(ll-o)ã€‚",
    code: `<span class="line hl">add_new_bigram(left_symbol.prev, bigram.left);  // e-ll</span>
<span class="line hl">add_new_bigram(bigram.left, left_symbol.next);  // ll-o</span>
<span class="line">// ç»§ç»­å¾ªç¯ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª bigram</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1,active:true},
      {text:'ll',prev:1,next:4,idx:2,merged:true,active:true},
      {text:'',prev:2,next:4,idx:3,deleted:true},
      {text:'o',prev:2,next:-1,idx:4,active:true}
    ],
    active: [1,2,4],
    queue: ['l+o(rank=12)', 'e+ll(rank=8)', 'll+o(rank=15)'],
    showQueue: true
  },
  {
    title: "æ­¥éª¤ 8: Resegment è¾“å‡º Token ID",
    desc: "BPE åˆå¹¶å®Œæˆåï¼Œéå†é“¾è¡¨è°ƒç”¨ resegment()ã€‚å¦‚æœ symbol.text åœ¨ token_to_id ä¸­å­˜åœ¨ï¼Œç›´æ¥è¾“å‡º token IDï¼›å¦åˆ™é€’å½’æŸ¥æ‰¾ rev_merge æ˜ å°„ï¼Œå°†åˆå¹¶åçš„ token æ‹†åˆ†å›åŸå§‹ tokenã€‚æœ€ç»ˆè¾“å‡º token ID åºåˆ—ã€‚",
    code: `<span class="line">for (int i = 0; i != -1; i = symbols[i].next) {</span>
<span class="line hl">    resegment(symbol, output);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line hl">// resegment: token_to_id.find(text) -> output token ID</span>`,
    symbols: [
      {text:'h',prev:-1,next:1,idx:0},
      {text:'e',prev:0,next:2,idx:1},
      {text:'ll',prev:1,next:4,idx:2,merged:true},
      {text:'',prev:2,next:4,idx:3,deleted:true},
      {text:'o',prev:2,next:-1,idx:4}
    ],
    active: [0,1,2,4],
    queue: [],
    showQueue: false,
    output: 'Output: [h, e, ll, o] â†’ token IDs'
  }
];

let currentStep = 0;

function openAnimModal() {
  currentStep = 0;
  renderAnimStep();
  document.getElementById('animModal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeAnimModal() {
  document.getElementById('animModal').classList.remove('open');
  document.body.style.overflow = '';
}

function renderAnimStep() {
  const step = ANIM_STEPS[currentStep];

  // Title and description
  document.getElementById('animStepTitle').textContent = step.title;
  document.getElementById('animStepDesc').textContent = step.desc;

  // Code
  document.getElementById('animCode').innerHTML = step.code;

  // Render linked list
  const listEl = document.getElementById('animLinkedList');
  listEl.innerHTML = '';

  step.symbols.forEach((sym, i) => {
    if (sym.deleted) {
      // Show deleted node with reduced opacity
      const node = document.createElement('div');
      node.className = 'll-node';
      node.style.opacity = '0.2';
      node.innerHTML = `<div class="char">Ã—</div><div class="meta">del</div>`;
      listEl.appendChild(node);
    } else {
      const node = document.createElement('div');
      node.className = 'll-node';
      if (step.active.includes(i)) node.classList.add('active');
      if (sym.merged) node.classList.add('merged');

      let meta = `prev:${sym.prev}`;
      if (sym.showPtr) meta += ` next:${sym.next}`;
      node.innerHTML = `<div class="char">${sym.text}</div><div class="meta">${meta}</div>`;
      listEl.appendChild(node);
    }

    // Arrow (except after last visible node)
    if (i < step.symbols.length - 1) {
      const nextSym = step.symbols[i + 1];
      const arrow = document.createElement('span');
      arrow.className = 'll-arrow';
      if (sym.deleted || (nextSym && nextSym.deleted)) {
        arrow.classList.add('inactive');
      }
      arrow.textContent = 'â†’';
      listEl.appendChild(arrow);
    }
  });

  // Queue
  const queueArea = document.getElementById('animQueueArea');
  const queueEl = document.getElementById('animQueue');
  if (step.showQueue && step.queue.length > 0) {
    queueArea.style.display = 'block';
    queueEl.innerHTML = step.queue.map(q => `<span class="queue-item">${q}</span>`).join('');
  } else {
    queueArea.style.display = 'none';
  }

  // Output (for final step)
  if (step.output) {
    const outputDiv = document.createElement('div');
    outputDiv.className = 'anim-desc';
    outputDiv.style.marginTop = '12px';
    outputDiv.innerHTML = `<p style="color:var(--green);font-weight:600;">${step.output}</p>`;
    const stage = document.querySelector('.anim-stage');
    const existing = stage.querySelector('.anim-desc');
    if (!existing) stage.appendChild(outputDiv);
  }

  // Navigation
  document.getElementById('animPrevBtn').disabled = currentStep === 0;
  document.getElementById('animNextBtn').disabled = currentStep === ANIM_STEPS.length - 1;
  document.getElementById('animCounter').textContent = `${currentStep + 1} / ${ANIM_STEPS.length}`;

  // Dots
  const dotsEl = document.getElementById('animDots');
  dotsEl.innerHTML = ANIM_STEPS.map((_, i) =>
    `<div class="step-dot ${i === currentStep ? 'active' : ''}" onclick="goToStep(${i})"></div>`
  ).join('');
}

function animNext() {
  if (currentStep < ANIM_STEPS.length - 1) {
    currentStep++;
    renderAnimStep();
  }
}

function animPrev() {
  if (currentStep > 0) {
    currentStep--;
    renderAnimStep();
  }
}

function goToStep(idx) {
  currentStep = idx;
  renderAnimStep();
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeAnimModal();
});

// Close modal on backdrop click
document.getElementById('animModal').addEventListener('click', (e) => {
  if (e.target.id === 'animModal') closeAnimModal();
});

render();
</script>
</body>
</html>
